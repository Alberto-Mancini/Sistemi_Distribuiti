<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risultati Ricerca - Casale Mancini</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Stanze Disponibili</a>
            <a href="/dashboard.html" class="btn btn-outline-light">Nuova Ricerca</a>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 id="results-title">Caricamento risultati...</h2>
        <div id="results-container" class="row g-4">
            <!-- I risultati verranno inseriti qui da JavaScript -->
        </div>
        <div id="booking-message" class="alert mt-4 d-none"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const date = params.get('date');
            const guests = params.get('guests');

            const resultsTitle = document.getElementById('results-title');
            const resultsContainer = document.getElementById('results-container');

            if (!date || !guests) {
                resultsTitle.textContent = 'Dati di ricerca mancanti. Torna alla dashboard per iniziare.';
                return;
            }

            resultsTitle.textContent = `Stanze disponibili per ${guests} ospiti in data ${new Date(date).toLocaleDateString()}`;

            fetch(`/api/rooms/available?date=${date}&guests=${guests}`)
                .then(response => response.json())
                .then(rooms => {
                    if (rooms.length === 0) {
                        resultsContainer.innerHTML = '<p class="text-center fs-4">Siamo spiacenti, non ci sono stanze disponibili che soddisfano i tuoi criteri. Prova con un\'altra data.</p>';
                        return;
                    }
                    
                    rooms.forEach(room => {
                        const cardHtml = `
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">${room.name}</h5>
                                        <p class="card-text">Capacità massima: ${room.capacity} ospiti</p>
                                        <p class="card-text flex-grow-1">${room.description}</p>
                                        <button class="btn btn-primary mt-auto" onclick="bookRoom('${room.name}')">Prenota Ora</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        resultsContainer.innerHTML += cardHtml;
                    });
                });
        });

        function bookRoom(roomName) {
            const params = new URLSearchParams(window.location.search);
            const bookingData = {
                name: params.get('name'),
                email: params.get('email'),
                phone: params.get('phone'),
                booking_date: params.get('date'),
                guests: parseInt(params.get('guests')),
                dining: params.get('dining') === '1',
                room_name: roomName
            };

            fetch('/api/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            })
            .then(response => response.json())
            .then(result => {
                const bookingMessage = document.getElementById('booking-message');
                bookingMessage.textContent = result.message;
                bookingMessage.className = 'alert alert-success mt-4';
                bookingMessage.classList.remove('d-none');
                document.getElementById('results-container').innerHTML = '<p class="text-center fs-3">Grazie per aver prenotato con noi!</p>';
                document.getElementById('results-title').textContent = 'Prenotazione Confermata!';
            })
            .catch(err => {
                const bookingMessage = document.getElementById('booking-message');
                bookingMessage.textContent = 'Si è verificato un errore durante la prenotazione.';
                bookingMessage.className = 'alert alert-danger mt-4';
                bookingMessage.classList.remove('d-none');
            });
        }
    </script>
</body>
</html>